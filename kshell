#!/usr/bin/env python3
"""
kshell â€” open an interactive shell in a pod selected by regex

Usage:
  kshell [-N NAMESPACE] [-c CONTAINER] <pod-regex> [shell-command...]

Examples:
  kshell app
  kshell -N production app
  kshell -c sidecar app
  kshell app /bin/bash
"""

import argparse
import os
import sys

# Import utilities from the same directory
from k8s_utils import (
    Colors, print_error, print_info, resolve_pod, run_command
)


def parse_args() -> argparse.Namespace:
    """Parse command line arguments."""
    parser = argparse.ArgumentParser(
        description="Open an interactive shell in a pod selected by regex",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  kshell app
  kshell -N production app
  kshell -c sidecar app
  kshell app /bin/bash
        """
    )
    
    parser.add_argument(
        '-N', '--namespace',
        help='Kubernetes namespace (optional)'
    )
    
    parser.add_argument(
        '-c', '--container',
        help='Container name (optional)'
    )
    
    parser.add_argument(
        'pod_regex',
        help='ERE matched against pod names (single pod must match)'
    )
    
    parser.add_argument(
        'shell_command',
        nargs=argparse.REMAINDER,
        help='Optional command to exec (default: /bin/sh)'
    )
    
    return parser.parse_args()


def main() -> None:
    """Main function."""
    args = parse_args()
    
    try:
        # Resolve the pod
        pod_name = resolve_pod(args.pod_regex, args.namespace)
        
        # Build kubectl exec command
        cmd = ['kubectl']
        if args.namespace:
            cmd.extend(['-n', args.namespace])
        cmd.extend(['exec', '-it', pod_name])
        
        if args.container:
            cmd.extend(['-c', args.container])
        
        # Add shell command (default to /bin/sh if none provided)
        if args.shell_command:
            cmd.append('--')
            cmd.extend(args.shell_command)
        else:
            cmd.extend(['--', '/bin/sh'])
        
        print_info(f"Opening shell in pod: {pod_name}")
        
        # Execute the command (don't capture output for interactive shell)
        run_command(cmd, capture_output=False, check=False)
        
    except KeyboardInterrupt:
        print("\nInterrupted by user", file=sys.stderr)
        sys.exit(1)
    except Exception as e:
        print_error(str(e))
        sys.exit(1)


if __name__ == '__main__':
    main()
