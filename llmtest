#!/bin/bash
# Generate unit test stubs for code
# Usage: llm-test function.py
#        llm-test --framework jest component.tsx
#        cat class.java | llm-test --framework junit

set -euo pipefail
source "$(dirname "$0")/ollama-lib"
ollama_capture_stdin
ollama_require

# Parse args
framework=""
file=""
while [[ $# -gt 0 ]]; do
    case "$1" in
        --framework) framework="$2"; shift 2 ;;
        *) file="$1"; shift ;;
    esac
done

# Read input and auto-detect test framework from extension
if [[ -n "$file" && -f "$file" ]]; then
    input=$(ollama_read_input 4000 "$file" "code")
    if [[ -z "$framework" ]]; then
        lang=$(ollama_detect_lang "$file")
        case "$lang" in
            python)     framework="pytest" ;;
            typescript) framework="jest with typescript" ;;
            javascript) framework="jest" ;;
            java)       framework="JUnit 5" ;;
            go)         framework="go test" ;;
            rust)       framework="Rust #[test]" ;;
            *)          framework="appropriate test framework" ;;
        esac
    fi
elif [[ -n "${OLLAMA_STDIN:-}" ]]; then
    input=$(ollama_read_input 4000 "" "code")
    framework="${framework:-appropriate test framework}"
else
    echo "No code provided" >&2
    exit 1
fi

system="Generate unit tests for this code using $framework.
Include:
- Happy path tests
- Edge cases (null, empty, boundary values)
- Error cases where appropriate

Output only the test code, ready to save to a test file.
Use descriptive test names. Include necessary imports."

ollama_generate "$MODEL_CODE" "$input" "$system"
