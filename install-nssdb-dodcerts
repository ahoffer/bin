#!/usr/bin/env bash
set -euo pipefail

# -----------------------------------------------------------------------------
# import-dod-certs.sh — import DoD root CAs into existing Chrome/NSS DB
# Idempotent: skips already-imported certs; errors if NSS DB missing.
# -----------------------------------------------------------------------------

# NSS DB directory spec
NSSDB="sql:$HOME/.pki/nssdb"
DB_PATH="$HOME/.pki/nssdb/cert9.db"

# Directory where DoD .crt files are placed (after update-ca-certificates)
DOD_DIR="/usr/local/share/ca-certificates/dod"

# 1) Check NSS DB
if [ ! -f "$DB_PATH" ]; then
  echo "✗ ERROR: NSS DB not found at $DB_PATH"
  echo "  Please run setup-nssdb.sh first to initialize NSS DB."
  exit 1
fi

# 2) Loop and import
for crt in "$DOD_DIR"/*.crt; do
  [ -f "$crt" ] || continue
  nick=$(basename "$crt" .crt)

  if certutil -d "$NSSDB" -L -n "$nick" &>/dev/null; then
    echo "✓ $nick already in NSS DB"
    continue
  fi

  echo "→ Importing $nick into NSS DB"
  if certutil -d "$NSSDB" -A -n "$nick" -t "CT,C,C" -i "$crt"; then
    echo "  ✅ Imported $nick"
  else
    echo "  ❗ Failed to import $nick"
  fi

done

