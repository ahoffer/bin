#!/bin/bash
set -euo pipefail

# Restart a Kubernetes deployment and wait for rollout
# Usage: k8srestartdeploy [-n namespace] [-t timeout] <deployment>
# Examples:
#   k8srestartdeploy cx-app                    # Restart in default namespace
#   k8srestartdeploy -n prod cx-app            # Restart in specific namespace
#   k8srestartdeploy -t 300s cx-app            # Custom timeout

usage() {
  sed -n '4,8p' "$0"
  exit 0
}

namespace="octocx"
timeout="120s"
quiet=false
while [[ $# -gt 0 && "$1" == -* ]]; do
  case "$1" in
    -h|--help) usage ;;
    -q|--quiet) quiet=true; shift ;;
    -n|--namespace) namespace="$2"; shift 2 ;;
    -t|--timeout) timeout="$2"; shift 2 ;;
    *) echo "Unknown option: $1" >&2; exit 1 ;;
  esac
done

readonly DEPLOY="${1:?Usage: k8srestartdeploy [-n namespace] [-t timeout] <deployment>}"
readonly NAMESPACE="$namespace"
readonly TIMEOUT="$timeout"

if ! kubectl get deployment "$DEPLOY" -n "$NAMESPACE" >/dev/null 2>&1; then
  if [[ -f k8s.yml ]]; then
    kubectl apply -f k8s.yml -n "$NAMESPACE" >/dev/null
  else
    exit 0
  fi
fi

$quiet || echo -n "    Restarting..."
kubectl rollout restart deployment "$DEPLOY" -n "$NAMESPACE" >/dev/null

if $quiet; then
  kubectl rollout status deployment "$DEPLOY" -n "$NAMESPACE" --timeout="$TIMEOUT" >/dev/null
else
  # Show progress on single line
  kubectl rollout status deployment "$DEPLOY" -n "$NAMESPACE" --timeout="$TIMEOUT" 2>&1 | while read -r line; do
    printf "\r    Rollout: %-60s" "${line:0:60}"
  done
  printf "\r    Rollout: done%-56s\n" ""
fi
