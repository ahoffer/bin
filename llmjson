#!/bin/bash
# Generate jq query from description
# Usage: llm-json "get all names from users array"
#        echo '{"users":[...]}' | llm-json "extract emails"

set -euo pipefail
source "$(dirname "$0")/ollama-lib"
ollama_capture_stdin 2000
ollama_require

if [[ $# -eq 0 ]]; then
    echo "Usage: llm-json \"what you want to extract\"" >&2
    echo "       echo '{...}' | llm-json \"description\"" >&2
    exit 1
fi

desc="$*"

prompt="$desc"
if [[ -n "$OLLAMA_STDIN" ]]; then
    prompt="Given this JSON sample:
$OLLAMA_STDIN

$desc"
fi

system="Generate a jq query for the request.
Output format:
QUERY: <the jq expression>
EXPLANATION: <what it does>

If input was provided, make the query work for that structure.
Keep it simple - one liner preferred unless complex."

ollama_generate "$MODEL_CHAT" "$prompt" "$system"
