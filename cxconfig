#!/bin/bash
set -euo pipefail

# Query cx-search project configuration
# Usage: cxconfig <command> [args]
# Commands:
#   components          List all component names
#   dir <component>     Get docker directory for component
#   deploy <component>  Get deployment name for component
#   image <component>   Get full image:tag for component
#   timeout <component> Get rollout timeout (seconds) for component
#   registry            Get the container registry
#   version             Get the current version

readonly CONFIG="${CX_CONFIG:-$HOME/.config/cx-search/components.conf}"

usage() {
  sed -n '4,11p' "$0"
  exit 0
}

[[ $# -eq 0 || "$1" == "-h" || "$1" == "--help" ]] && usage

if [[ ! -f "$CONFIG" ]]; then
  echo "Error: Config file not found: $CONFIG" >&2
  exit 1
fi

get_setting() {
  grep "^$1=" "$CONFIG" | cut -d= -f2-
}

get_component_field() {
  local component="$1" field="$2"
  local value
  value=$(grep "^${component}:" "$CONFIG" | cut -d: -f"$field")
  echo "$value"
}

get_component_dir() {
  local component="$1"
  local dir
  dir=$(get_component_field "$component" 2)
  [[ -n "$dir" ]] || { echo "Error: Unknown component '$component'" >&2; exit 1; }
  echo "$dir"
}

case "$1" in
  components)
    grep -E '^[a-z].*:' "$CONFIG" | cut -d: -f1
    ;;
  dir)
    get_component_dir "${2:?Usage: cxconfig dir <component>}"
    ;;
  deploy)
    dir=$(get_component_dir "${2:?Usage: cxconfig deploy <component>}")
    echo "cx-${dir#cx-}"  # strip cx- prefix if present, then add it back
    ;;
  image)
    dir=$(get_component_dir "${2:?Usage: cxconfig image <component>}")
    registry=$(get_setting registry)
    version=$(get_setting version)
    echo "$registry/$dir:$version"
    ;;
  timeout)
    component="${2:?Usage: cxconfig timeout <component>}"
    get_component_dir "$component" >/dev/null  # validate component exists
    timeout=$(get_component_field "$component" 3)
    echo "${timeout:-$(get_setting default_timeout)}"
    ;;
  registry)
    get_setting registry
    ;;
  version)
    get_setting version
    ;;
  *)
    echo "Unknown command: $1" >&2
    usage
    ;;
esac
