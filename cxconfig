#!/bin/bash
set -euo pipefail

# Query component configuration for cx or marrs projects
#
# Used by cxbuild to find docker dirs
# Used by cxdeploy (to find image/deploy/timeout)
#
# Usage: cxconfig [-a app] <command> [args]
#
# Options:
#   -a, --app APP      cx or marrs. Attempts autodetect
#
# Commands:
#   components          List all component names
#   dir <component>     Get docker directory for component
#   deploy <component>  Get k8s deployment name for component
#   image <component>   Get full image:tag (registry/dir:version)
#   timeout <component> Get rollout timeout in seconds
#   registry            Get the container registry URL
#   version             Get the current build version
#   namespace           Get the k8s namespace for this app
#   app                 Get the detected/selected app name
#   root                Get the default project root

usage() {
  sed -n '3,21p' "$0"
  exit 0
}

# Find project root by walking up looking for pom.xml
find_project_root() {
  local dir="$PWD"
  local last_with_pom=""
  while [[ "$dir" != "/" ]]; do
    if [[ -f "$dir/pom.xml" ]]; then
      last_with_pom="$dir"
    fi
    dir="$(dirname "$dir")"
  done
  echo "$last_with_pom"
}

# Auto-detect app from project root directory name
detect_app() {
  local root
  root=$(find_project_root)
  if [[ -z "$root" ]]; then
    echo "cx"  # default when not in a project
    return
  fi
  local dirname
  dirname=$(basename "$root")
  case "$dirname" in
    marrs) echo "marrs" ;;
    cx-search) echo "cx" ;;
    *) echo "cx" ;;  # default
  esac
}

app=""
while [[ $# -gt 0 && "$1" == -* ]]; do
  case "$1" in
    -h|--help) usage ;;
    -a|--app) app="$2"; shift 2 ;;
    *) break ;;  # let command handle unknown options
  esac
done

[[ -z "$app" ]] && app=$(detect_app)

readonly APP="$app"
readonly CONFIG="$HOME/.config/$APP/components.conf"

[[ $# -eq 0 || "$1" == "-h" || "$1" == "--help" ]] && usage

if [[ ! -f "$CONFIG" ]]; then
  echo "Error: Config file not found: $CONFIG" >&2
  exit 1
fi

get_setting() {
  grep "^$1=" "$CONFIG" | cut -d= -f2-
}

get_component_field() {
  local component="$1" field="$2"
  local value
  value=$(grep "^${component}:" "$CONFIG" | cut -d: -f"$field")
  echo "$value"
}

get_component_dir() {
  local component="$1"
  local dir
  dir=$(get_component_field "$component" 2)
  [[ -n "$dir" ]] || { echo "Error: Unknown component '$component'" >&2; exit 1; }
  echo "$dir"
}

get_namespace() {
  case "$APP" in
    cx) echo "octocx" ;;
    marrs) echo "marrs" ;;
    *) echo "$APP" ;;
  esac
}

get_deploy_prefix() {
  case "$APP" in
    cx) echo "cx" ;;
    marrs) echo "marrs" ;;
    *) echo "$APP" ;;
  esac
}

get_version() {
  local root
  root=$(find_project_root)
  [[ -z "$root" ]] && { echo "Error: Not in a project (no pom.xml found)" >&2; exit 1; }
  grep -m1 '<version>' "$root/pom.xml" | sed 's/.*<version>\(.*\)<\/version>.*/\1/'
}

case "$1" in
  components)
    grep -E '^[a-z].*:' "$CONFIG" | cut -d: -f1
    ;;
  dir)
    get_component_dir "${2:?Usage: cxconfig dir <component>}"
    ;;
  deploy)
    dir=$(get_component_dir "${2:?Usage: cxconfig deploy <component>}")
    prefix=$(get_deploy_prefix)
    # strip any existing prefix, then add the correct one
    dir="${dir#cx-}"
    dir="${dir#marrs-}"
    # avoid "marrs-marrs" â†’ just "marrs"
    if [[ "$dir" == "$prefix" ]]; then
      echo "$prefix"
    else
      echo "${prefix}-${dir}"
    fi
    ;;
  image)
    dir=$(get_component_dir "${2:?Usage: cxconfig image <component>}")
    registry=$(get_setting registry)
    version=$(get_version)
    echo "$registry/$dir:$version"
    ;;
  timeout)
    component="${2:?Usage: cxconfig timeout <component>}"
    get_component_dir "$component" >/dev/null  # validate component exists
    timeout=$(get_component_field "$component" 3)
    echo "${timeout:-$(get_setting default_timeout)}"
    ;;
  registry)
    get_setting registry
    ;;
  version)
    get_version
    ;;
  namespace)
    get_namespace
    ;;
  app)
    echo "$APP"
    ;;
  root)
    root=$(find_project_root)
    [[ -z "$root" ]] && { echo "Error: Not in a project (no pom.xml found)" >&2; exit 1; }
    echo "$root"
    ;;
  *)
    echo "Unknown command: $1" >&2
    usage
    ;;
esac
