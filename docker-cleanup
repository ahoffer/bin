#!/usr/bin/env python3
"""Clean up Docker images, keeping only the latest snapshot and latest non-snapshot per repository."""

import argparse
import subprocess
import sys
from collections import defaultdict


def parse_version(tag):
    """Parse semver tag into comparable tuple. Returns None for non-semver."""
    base = tag.removesuffix("-SNAPSHOT")
    try:
        return tuple(int(p) for p in base.split(".")[:3])
    except ValueError:
        return None


def get_images():
    """Yield (repo, tag) tuples from docker images."""
    result = subprocess.run(
        ["docker", "images", "--format", "{{.Repository}} {{.Tag}}"],
        capture_output=True, text=True, check=True
    )
    for line in result.stdout.splitlines():
        parts = line.split(None, 1)
        if len(parts) == 2 and parts[1] != "<none>":
            yield parts[0], parts[1]


def main():
    p = argparse.ArgumentParser(description=__doc__)
    p.add_argument("-d", "--dry-run", action="store_true", help="Show what would be deleted")
    p.add_argument("-v", "--verbose", action="store_true", help="Show images being kept")
    args = p.parse_args()

    latest_release = defaultdict(lambda: (None, None))  # repo -> (version_tuple, tag)
    latest_snapshot = defaultdict(lambda: (None, None))

    for repo, tag in get_images():
        ver = parse_version(tag)
        is_snapshot = tag.endswith("-SNAPSHOT")
        store = latest_snapshot if is_snapshot else latest_release
        if ver and (store[repo][0] is None or ver > store[repo][0]):
            store[repo] = (ver, tag)

    to_remove = []
    for repo, tag in get_images():
        is_snapshot = tag.endswith("-SNAPSHOT")
        keep_tag = (latest_snapshot if is_snapshot else latest_release)[repo][1]
        if tag == keep_tag:
            if args.verbose:
                print(f"KEEP: {repo}:{tag}")
        else:
            to_remove.append(f"{repo}:{tag}")

    if not to_remove:
        print("No images to remove.")
        return 0

    print(f"Images to remove: {len(to_remove)}")
    for img in to_remove:
        if args.dry_run:
            print(f"Would remove: {img}")
        else:
            print(f"Removing: {img}")
            subprocess.run(["docker", "rmi", img], check=False)

    if args.dry_run:
        print("\n(Dry run - no images were actually removed. Run without -d to delete.)")
    return 0


if __name__ == "__main__":
    sys.exit(main())
