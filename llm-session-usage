#!/bin/bash
# Show Ollama token usage for current Claude Code session
# Usage: llm-session-usage

set -euo pipefail

USAGE_LOG="${OLLAMA_USAGE_LOG:-$HOME/.cache/ollama-usage.jsonl}"
CONVO_FILE="$HOME/.cache/ollama-conversation-id"

if [[ ! -f "$USAGE_LOG" ]]; then
    echo "No usage log found at $USAGE_LOG"
    exit 0
fi

# Get current conversation ID
CONVO_ID=""
if [[ -n "${OLLAMA_CONVERSATION_ID:-}" ]]; then
    CONVO_ID="$OLLAMA_CONVERSATION_ID"
elif [[ -f "$CONVO_FILE" ]]; then
    CONVO_ID=$(cat "$CONVO_FILE")
fi

if [[ -z "$CONVO_ID" ]]; then
    echo "No conversation ID found"
    exit 1
fi

# Filter and sum tokens for this session
STATS=$(jq -s --arg convo "$CONVO_ID" '
    [.[] | select(.convo == $convo)] |
    {
        calls: length,
        prompt_tokens: (map(.prompt_tokens // 0) | add),
        completion_tokens: (map(.completion_tokens // 0) | add),
        by_tool: (group_by(.tool) | map({
            tool: .[0].tool,
            calls: length,
            tokens: (map((.prompt_tokens // 0) + (.completion_tokens // 0)) | add)
        }) | sort_by(-.tokens))
    }
' "$USAGE_LOG")

CALLS=$(echo "$STATS" | jq -r '.calls')
PROMPT=$(echo "$STATS" | jq -r '.prompt_tokens // 0')
COMPLETION=$(echo "$STATS" | jq -r '.completion_tokens // 0')
TOTAL=$((PROMPT + COMPLETION))

# Check for --oneline flag
if [[ "${1:-}" == "--oneline" || "${1:-}" == "-1" ]]; then
    TOOLS=$(echo "$STATS" | jq -r '[.by_tool[] | "\(.tool):\(.calls)"] | join(", ")' 2>/dev/null || echo "")
    if [[ -n "$TOOLS" ]]; then
        echo "Ollama: ${TOTAL} tokens (${CALLS} calls) [$TOOLS]"
    else
        echo "Ollama: ${TOTAL} tokens (${CALLS} calls)"
    fi
    exit 0
fi

echo "Ollama usage for session $CONVO_ID"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Total calls:       $CALLS"
echo "Prompt tokens:     $PROMPT"
echo "Completion tokens: $COMPLETION"
echo "Total tokens:      $TOTAL"
echo ""
echo "By tool:"
echo "$STATS" | jq -r '.by_tool[] | "  \(.tool): \(.calls) calls, \(.tokens) tokens"'
