#!/bin/bash
set -euo pipefail

if [[ "$(id -u)" -ne 0 ]]; then
  echo "Error: run as root (sudo)" >&2
  exit 1
fi

# Script to completely remove snap packages and snapd from Ubuntu
# Run with: sudo bash remove_snap.sh

echo "Starting snap removal process..."

# Step 1: Remove all snap packages
echo "Removing all installed snap packages..."
snap list | awk 'NR>1 {print $1}' | while read -r snap; do
  echo "Removing $snap..."
  snap remove --purge "$snap"
done

# Step 2: Remove snapd itself
echo "Removing snapd..."
systemctl stop snapd
systemctl disable snapd
systemctl mask snapd
apt remove --autoremove snapd

# Step 3: Remove snap directories
echo "Cleaning up snap directories..."
rm -rf /var/cache/snapd/
rm -rf ~/snap
rm -rf /snap
rm -rf /var/snap
rm -rf /var/lib/snapd

# Step 4: Prevent snap from being reinstalled
echo "Preventing snap reinstallation..."
if [ -f /etc/apt/preferences.d/nosnap.pref ]; then
  cp /etc/apt/preferences.d/nosnap.pref /etc/apt/preferences.d/nosnap.pref.bak
fi
cat << 'EOF' > /etc/apt/preferences.d/nosnap.pref
# To prevent repository packages from triggering the installation of Snap,
# this file forbids snapd from being installed by APT.
# For more information: https://linuxmint-user-guide.readthedocs.io/en/latest/snap.html

Package: snapd
Pin: release a=*
Pin-Priority: -10
EOF

echo "Snap removal complete!"
echo "You may want to reboot your system to ensure all snap-related processes are terminated."
echo "After reboot, you can verify removal with: mount | grep snap"
