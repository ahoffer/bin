#!/usr/bin/env bash
set -euo pipefail

# usage: sudo setup-pcsc.sh <username> [<vendor> <product>]
if (( EUID != 0 )); then
  echo "Usage: sudo $0 <username> [<vendor> <product>]"
  exit 1
fi
if (( $# < 1 )); then
  echo "Usage: sudo $0 <username> [<vendor> <product>]"
  exit 1
fi

USERNAME="$1"
shift

echo "Enabling PC/SC service..."
systemctl enable --now pcscd.socket pcscd.service

echo "Ensuring pcscd group exists..."
if ! getent group pcscd >/dev/null; then
  groupadd --system pcscd
  echo "Created pcscd group"
else
  echo "pcscd group exists"
fi

echo "Adding user '$USERNAME' to pcscd group..."
if id -nG "$USERNAME" | grep -qw pcscd; then
  echo "User '$USERNAME' is already in pcscd group"
else
  usermod -aG pcscd "$USERNAME"
  echo "Added '$USERNAME' to pcscd group"
fi

echo "Writing Polkit policy..."
PKLA=/etc/polkit-1/localauthority/50-local.d/55-pcscd.pkla
cat >"$PKLA" <<'EOF'
[Allow PC/SC access for pcscd group]
Identity=unix-group:pcscd
Action=org.debian.pcsc-lite.access_pcsc;org.debian.pcsc-lite.access_card
ResultAny=yes
ResultInactive=yes
ResultActive=yes
EOF
chmod 644 "$PKLA"
echo "Polkit policy written"

# detect vendor and product IDs
if (( $# == 2 )); then
  VID="$1"
  PID="$2"
  echo "Using provided vendor:product $VID:$PID"
else
  echo "Detecting smartcard reader via sysfs..."
  VID=""
  PID=""
  if [ -d /sys/bus/usb/drivers/ccid ]; then
    for entry in /sys/bus/usb/drivers/ccid/*; do
      if [[ $entry =~ :1\.0$ ]]; then
        devpath=$(readlink -f "$entry")
        parent=${devpath%%:*}
        parent=${parent%/*}
        if [[ -f "$parent/idVendor" && -f "$parent/idProduct" ]]; then
          VID=$(cat "$parent/idVendor")
          PID=$(cat "$parent/idProduct")
          echo "Found smartcard reader $VID:$PID"
          break
        fi
      fi
    done
  fi
  if [[ -z "$VID" ]]; then
    echo "No smartcard reader detected"
    echo "Run 'lsusb' to find vendor and product IDs, then re-run:"
    echo "  sudo $0 <username> <vendor> <product>"
    exit 1
  fi
fi

echo "Writing udev rule to disable USB autosuspend for $VID:$PID..."
UDEV=/etc/udev/rules.d/99-usb-smartcard.rules
cat >"$UDEV" <<EOF
ACTION=="add", SUBSYSTEM=="usb", ATTR{idVendor}=="$VID", ATTR{idProduct}=="$PID", TEST=="power/control", ATTR{power/control}="on"
EOF
echo "udev rule written"

echo "Reloading udev rules..."
udevadm control --reload
udevadm trigger

cat <<MSG

Setup complete!

1. Unplug and re-plug the reader or re-run with vendor and product override.
2. Log out and back in to apply group and Polkit changes.
3. Reboot the system to ensure group membership and rules fully take effect.

Now run 'pcsc_scan' as a normal user.
MSG

