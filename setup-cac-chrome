#!/usr/bin/env bash
set -euo pipefail

# ‚Äî‚Äî CONFIG ‚Äî‚Äî
DB_DIR="$HOME/.config/google-chrome/Default"
MODULE="/usr/lib/x86_64-linux-gnu/opensc-pkcs11.so"
CA_DIR="$HOME/DoD-CAs"
LOCAL_STATE="$HOME/.config/google-chrome/Local State"

# ‚Äî‚Äî PRECHECKS ‚Äî‚Äî
if pgrep -x "chrome" >/dev/null; then
  echo "‚ö†Ô∏è  Please fully quit ALL Chrome processes before running this."
  exit 1
fi

if [ ! -d "$DB_DIR" ]; then
  echo "‚ùå Couldn‚Äôt find your Chrome profile at $DB_DIR"
  exit 1
fi

# ‚Äî‚Äî 1) Register the PKCS#11 module idempotently ‚Äî‚Äî
if ! modutil -dbdir "sql:$DB_DIR" -list \
        | grep -qF "CAC OpenSC"; then
  echo "üîë Adding OpenSC PKCS#11 module to Chrome profile‚Ä¶"
  modutil -dbdir "sql:$DB_DIR" \
          -add "CAC OpenSC" \
          -libfile "$MODULE" \
          -force
else
  echo "üîë OpenSC module already registered‚Äîskipping."
fi

# ‚Äî‚Äî 2) Import DoD Root CAs idempotently ‚Äî‚Äî
echo "üõ°Ô∏è  Ensuring DoD Root CAs are in the NSS DB‚Ä¶"
for cert in "$CA_DIR"/DoD-*.pem; do
  [ -f "$cert" ] || continue
  name=$(basename "$cert" .pem)
  if ! certutil -d "sql:$DB_DIR" -L \
         | grep -qF "$name"; then
    echo "   ‚Üí Importing $name"
    certutil -d "sql:$DB_DIR" \
             -A -n "$name" \
             -t "C,," \
             -i "$cert"
  else
    echo "   ‚Üí $name already trusted‚Äîskipping."
  fi
done

# ‚Äî‚Äî 3) Enable ‚Äúnetwork-service-in-process‚Äù idempotently ‚Äî‚Äî
if command -v jq >/dev/null && [ -f "$LOCAL_STATE" ]; then
  echo "‚öôÔ∏è  Toggling network-service-in-process in Local State‚Ä¶"
  tmp=$(mktemp)
  jq '
    .browser.enabled_labs_experiments |=
      (if type=="array" then . + ["network-service-in-process"]
       else ["network-service-in-process"] end)
    | .browser.enabled_labs_experiments |= unique
  ' "$LOCAL_STATE" > "$tmp"
  mv "$tmp" "$LOCAL_STATE"
else
  echo "‚ö†Ô∏è  Skipped flag-tweak (jq or Local State missing)."
  echo "   If needed, install jq or manually set chrome://flags/#network-service to Disabled."
fi

echo
echo "‚úÖ  Done! From now on just run:"
echo
echo "    google-chrome"
echo
