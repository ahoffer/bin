#!/bin/bash
# Shell integration for automatic LLM assistance
# Add to .bashrc: source ~/bin/llm-shell-integration

# Auto-explain errors when commands fail (opt-in)
# Set LLM_AUTO_EXPLAIN=1 to enable
__llm_prompt_command() {
    local exit_code=$?

    # Only if enabled and command failed
    if [[ "${LLM_AUTO_EXPLAIN:-0}" != "1" ]] || [[ $exit_code -eq 0 ]]; then
        return $exit_code
    fi

    # Get last command
    local last_cmd
    last_cmd=$(history 1 | sed 's/^[ ]*[0-9]*[ ]*//')

    # Skip if it's an llm- command (avoid loops)
    if [[ "$last_cmd" == llm-* ]]; then
        return $exit_code
    fi

    # Check if we have recent stderr (bash doesn't capture this easily)
    # This is a best-effort feature
    echo -e "\n\033[33m[LLM] Command failed (exit $exit_code). Getting explanation...\033[0m"
    llm-explain-error "Command '$last_cmd' failed with exit code $exit_code" 2>/dev/null || true

    return $exit_code
}

# Quick LLM functions for interactive use
llm() {
    case "${1:-}" in
        ask|a)     shift; llm-ask "$@" ;;
        code|c)    shift; llm-gen-code "$@" ;;
        shell|sh)  shift; llm-shell "$@" ;;
        review|r)  shift; llm-review "$@" ;;
        test|t)    shift; llm-test "$@" ;;
        doc|d)     shift; llm-docstring "$@" ;;
        err|e)     shift; llm-explain-error "$@" ;;
        sum|s)     shift; llm-summarize "$@" ;;
        commit)    shift; llm-commit-msg "$@" ;;
        regex)     shift; llm-regex "$@" ;;
        jq)        shift; llm-json "$@" ;;
        index)     shift; llm-index "$@" ;;
        find)      shift; llm-index --search "$@" ;;
        watch)     shift; llm-watch "$@" ;;
        *)
            echo "Usage: llm <command> [args]"
            echo ""
            echo "Commands:"
            echo "  ask, a      Quick Q&A"
            echo "  code, c     Generate code"
            echo "  shell, sh   Generate shell command"
            echo "  review, r   Code review"
            echo "  test, t     Generate tests"
            echo "  doc, d      Generate docstring"
            echo "  err, e      Explain error"
            echo "  sum, s      Summarize"
            echo "  commit      Generate commit message"
            echo "  regex       Generate regex"
            echo "  jq          Generate jq query"
            echo "  index       Index codebase"
            echo "  find        Semantic search"
            echo "  watch       Watch & summarize"
            ;;
    esac
}

# Enable tab completion for llm function
_llm_completions() {
    local cur="${COMP_WORDS[COMP_CWORD]}"
    local commands="ask a code c shell sh review r test t doc d err e sum s commit regex jq index find watch"
    COMPREPLY=($(compgen -W "$commands" -- "$cur"))
}
complete -F _llm_completions llm

# Optional: Enable auto-explain by uncommenting:
# export LLM_AUTO_EXPLAIN=1
# PROMPT_COMMAND="__llm_prompt_command; ${PROMPT_COMMAND:-}"

echo "LLM shell integration loaded. Type 'llm' for help."
echo "To enable auto-explain on errors: export LLM_AUTO_EXPLAIN=1"
