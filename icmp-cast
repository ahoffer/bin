#!/usr/bin/python3

import socket
import struct
import sys
import os

def send_file(sock, target_addr, filename):
    with open(filename, "rb") as f:
        while chunk := f.read(1024):
            sock.sendto(chunk, target_addr)
    print(f"Sent {filename} â†’ {target_addr}")

def create_socket(mode):
    if mode == "broadcast":
        s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        s.setsockopt(socket.SOL_SOCKET, socket.SO_BROADCAST, 1)
        address = ("255.255.255.255", port)
    elif mode == "multicast":
        s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, socket.IPPROTO_UDP)
        ttl = struct.pack('b', 1)
        s.setsockopt(socket.IPPROTO_IP, socket.IP_MULTICAST_TTL, ttl)
        address = ("224.1.1.1", port)
    else:
        raise ValueError(f"Unsupported mode: {mode}")
    return s, address

# --- Main ---
if len(sys.argv) != 4:
    print(f"Usage: {sys.argv[0]} <broadcast|multicast> <file-to-send> <port>")
    sys.exit(1)

mode = sys.argv[1]
filename = sys.argv[2]
port = int(sys.argv[3])

if not os.path.isfile(filename):
    print(f"File not found: {filename}")
    sys.exit(1)

sock, addr = create_socket(mode)
send_file(sock, addr, filename)

