#!/usr/bin/env bash
set -euo pipefail
IMAGE="busybox:1.36"
POD="kbb-$$"
LOG="$HOME/kbb.log"

[ $# -eq 0 ] && { echo "usage: $0 <command>"; exit 1; }

trap 'kubectl delete pod "$POD" --now --wait=false >/dev/null 2>&1 || true' EXIT

kubectl run "$POD" --image="$IMAGE" --restart=Never -- sleep infinity >/dev/null 2>&1
kubectl wait --for=condition=Ready pod/"$POD" --timeout=30s >/dev/null 2>&1

kubectl exec "$POD" -- sh -lc "$*" 2>&1 | tee -a "$LOG"

