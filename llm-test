#!/bin/bash
# Generate unit test stubs for code
# Usage: llm-test function.py
#        llm-test --framework jest component.tsx
#        cat class.java | llm-test --framework junit

set -euo pipefail

# Capture stdin immediately if piped (before sourcing library)
stdin_content=""
if [[ ! -t 0 ]]; then
    stdin_content=$(cat)
fi

source "$(dirname "$0")/ollama-lib"
OLLAMA_TOOL_NAME="test"

if ! ollama_ping; then
    echo "Error: Cannot reach Ollama at $OLLAMA_HOST" >&2
    exit 1
fi

# Parse args
framework=""
file=""
while [[ $# -gt 0 ]]; do
    case "$1" in
        --framework) framework="$2"; shift 2 ;;
        *) file="$1"; shift ;;
    esac
done

# Read input
if [[ -n "$file" && -f "$file" ]]; then
    input=$(cat "$file" | truncate_input 4000)
    # Auto-detect framework
    if [[ -z "$framework" ]]; then
        case "$file" in
            *.py) framework="pytest" ;;
            *.ts|*.tsx) framework="jest with typescript" ;;
            *.js|*.jsx) framework="jest" ;;
            *.java) framework="JUnit 5" ;;
            *.go) framework="go test" ;;
            *.rs) framework="Rust #[test]" ;;
            *) framework="appropriate test framework" ;;
        esac
    fi
elif [[ -n "$stdin_content" ]]; then
    input=$(echo "$stdin_content" | truncate_input 4000)
    framework="${framework:-appropriate test framework}"
else
    echo "No code provided" >&2
    exit 1
fi

system="Generate unit tests for this code using $framework.
Include:
- Happy path tests
- Edge cases (null, empty, boundary values)
- Error cases where appropriate

Output only the test code, ready to save to a test file.
Use descriptive test names. Include necessary imports."

ollama_generate "$MODEL_CODE" "$input" "$system"
