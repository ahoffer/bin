#!/bin/bash
# Git hook helper - install with: llm-git-hook install
# Provides: commit-msg suggestions, pre-push summaries

set -euo pipefail

SCRIPT_DIR="$(dirname "$0")"

install_hooks() {
    local git_dir
    git_dir=$(git rev-parse --git-dir 2>/dev/null)

    if [[ -z "$git_dir" ]]; then
        echo "Not in a git repository" >&2
        exit 1
    fi

    local hooks_dir="$git_dir/hooks"
    mkdir -p "$hooks_dir"

    # prepare-commit-msg hook - suggest commit message
    cat > "$hooks_dir/prepare-commit-msg" << 'HOOK'
#!/bin/bash
# Auto-suggest commit message using Ollama
COMMIT_MSG_FILE="$1"
COMMIT_SOURCE="$2"

# Only run for new commits (not merge, squash, etc.)
if [[ -n "$COMMIT_SOURCE" ]]; then
    exit 0
fi

# Check if message already has content (user provided -m)
if [[ -s "$COMMIT_MSG_FILE" ]] && ! grep -q "^#" "$COMMIT_MSG_FILE"; then
    exit 0
fi

# Try to generate suggestion
if command -v llm-commit-msg &>/dev/null; then
    suggestion=$(llm-commit-msg 2>/dev/null || true)
    if [[ -n "$suggestion" ]]; then
        # Prepend suggestion as comment
        {
            echo "# Suggested commit message (uncomment or edit):"
            echo "# $suggestion"
            echo ""
            cat "$COMMIT_MSG_FILE"
        } > "$COMMIT_MSG_FILE.tmp"
        mv "$COMMIT_MSG_FILE.tmp" "$COMMIT_MSG_FILE"
    fi
fi
HOOK
    chmod +x "$hooks_dir/prepare-commit-msg"

    # post-commit hook - summarize what was committed
    cat > "$hooks_dir/post-commit" << 'HOOK'
#!/bin/bash
# Summarize commit (optional, non-blocking)
if [[ "${LLM_POST_COMMIT:-0}" == "1" ]] && command -v llm-summarize &>/dev/null; then
    echo "---"
    git show --stat HEAD | llm-summarize 2>/dev/null || true
fi
HOOK
    chmod +x "$hooks_dir/post-commit"

    echo "Installed hooks to $hooks_dir:"
    echo "  - prepare-commit-msg: suggests commit messages"
    echo "  - post-commit: summarizes commits (set LLM_POST_COMMIT=1 to enable)"
}

uninstall_hooks() {
    local git_dir
    git_dir=$(git rev-parse --git-dir 2>/dev/null)

    if [[ -z "$git_dir" ]]; then
        echo "Not in a git repository" >&2
        exit 1
    fi

    rm -f "$git_dir/hooks/prepare-commit-msg" "$git_dir/hooks/post-commit"
    echo "Removed LLM git hooks"
}

case "${1:-}" in
    install)
        install_hooks
        ;;
    uninstall)
        uninstall_hooks
        ;;
    *)
        echo "Usage: llm-git-hook [install|uninstall]"
        echo ""
        echo "Installs git hooks that use Ollama for:"
        echo "  - Suggesting commit messages"
        echo "  - Summarizing commits"
        ;;
esac
