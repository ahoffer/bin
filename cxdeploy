#!/bin/bash
set -euo pipefail

# Deploy a component to k3s (push image + restart pods + verify)
#
# Must be run from within a project directory (walks up to find pom.xml).
# App is auto-detected from the project root directory name.
#
# Usage: cxdeploy [-r host] [-n namespace] <component>
#
# Options:
#   -r, --remote HOST   Target k3s node (default: bigfish)
#   -n, --namespace NS  Kubernetes namespace (default: auto from app)

source cxlib.sh

usage() {
  sed -n '4,13p' "$0"
  echo -e "\nComponents: $(list_components)"
  exit 0
}

remote_host="bigfish"
namespace=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help) usage ;;
    -r|--remote) remote_host="$2"; shift 2 ;;
    -n|--namespace) namespace="$2"; shift 2 ;;
    -*) echo "Unknown option: $1" >&2; exit 1 ;;
    *) break ;;
  esac
done

component="${1:?Usage: cxdeploy [-r host] [-n namespace] <component>}"

require_project_root
acquire_lock "deploy"

mapfile -t all_components < <(cxconfig components)
valid_component "$component" all_components || { err_msg "Unknown component '$component'"; exit 1; }

[[ -z "$namespace" ]] && namespace=$(cxconfig namespace)

image=$(cxconfig image "$component")
image_age=$(imageage "$image")

# Check local image exists
local_hash=$(docker inspect --format='{{.Id}}' "$image" 2>/dev/null) || local_hash=""
[[ -z "$local_hash" ]] && { err_msg "Local image not found, build first"; exit 1; }

# Warn if local image matches deployed version
if ssh -o ConnectTimeout=5 -o BatchMode=yes "$remote_host" true 2>/dev/null; then
  remote_hash=$(ssh "$remote_host" "sudo nerdctl -n k8s.io inspect --format='{{.Id}}' '$image'" 2>/dev/null) || remote_hash=""
  if [[ -n "$remote_hash" && "$local_hash" == "$remote_hash" ]]; then
    warn_msg "Image unchanged from deployed version. Did you forget to build?"
    read -p "Continue anyway? [y/N] " -n 1 -r
    echo
    [[ ! $REPLY =~ ^[Yy]$ ]] && exit 1
  fi
fi

echo "image $image, ${image_age} old"
deploy_component "$component" "$remote_host" "$namespace" || exit 1
