#!/bin/bash
set -euo pipefail

# Deploy a component to k3s (push image + restart pods + verify)
#
# Must be run from within a project directory (walks up to find pom.xml).
# App is auto-detected from the project root directory name.
#
# Usage: cxdeploy [-r host] [-n namespace] <component>
#
# Options:
#   -r, --remote HOST   Target k3s node (default: bigfish)
#   -n, --namespace NS  Kubernetes namespace (default: auto from app)

source cx-lib.sh

usage() {
  sed -n '4,13p' "$0"
  echo -e "\nComponents: $(cx_list_components)"
  exit 0
}

remote_host="bigfish"
namespace=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help) usage ;;
    -r|--remote) remote_host="$2"; shift 2 ;;
    -n|--namespace) namespace="$2"; shift 2 ;;
    -*) echo "Unknown option: $1" >&2; exit 1 ;;
    *) break ;;
  esac
done

component="${1:?Usage: cxdeploy [-r host] [-n namespace] <component>}"

# Verify we're in a project directory (walks up tree like git)
cx_require_project_root

[[ -z "$namespace" ]] && namespace=$(cxconfig namespace)

image=$(cxconfig image "$component")
deploy=$(cxconfig deploy "$component")
timeout=$(cxconfig timeout "$component")
image_age=$(image-age "$image")

# Check local image exists
local_hash=$(docker inspect --format='{{.Id}}' "$image" 2>/dev/null) || local_hash=""
[[ -z "$local_hash" ]] && { echo "ERROR: Local image not found - build first" >&2; exit 1; }

# Warn if local image matches deployed version
if ssh -o ConnectTimeout=5 -o BatchMode=yes "$remote_host" true 2>/dev/null; then
  remote_hash=$(ssh "$remote_host" "sudo nerdctl -n k8s.io inspect --format='{{.Id}}' '$image'" 2>/dev/null) || remote_hash=""
  if [[ -n "$remote_hash" && "$local_hash" == "$remote_hash" ]]; then
    echo "WARNING: Image unchanged from deployed version - did you forget to build?"
    read -p "Continue anyway? [y/N] " -n 1 -r
    echo
    [[ ! $REPLY =~ ^[Yy]$ ]] && exit 1
  fi
fi

echo "==> Deploying $component ($deploy, $image_age old)"
deploy-image.sh -q -r "$remote_host" -n "$namespace" -t "$timeout" "$image" "$deploy"
