#!/bin/bash
set -euo pipefail

# Deploy a cx-search component to k3s
# Usage: cxdeploy [-r host] [-n namespace] <component>
# Examples:
#   cxdeploy graphql                  # Deploy graphql component
#   cxdeploy -r node2 edge            # Deploy to alternate host

readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

usage() {
  sed -n '4,7p' "$0"
  echo -e "\nComponents: $(cxconfig components | tr '\n' ' ')"
  exit 0
}

remote_host="bigfish"
namespace="octocx"
while [[ $# -gt 0 && "$1" == -* ]]; do
  case "$1" in
    -h|--help) usage ;;
    -r|--remote) remote_host="$2"; shift 2 ;;
    -n|--namespace) namespace="$2"; shift 2 ;;
    *) echo "Unknown option: $1" >&2; exit 1 ;;
  esac
done

readonly COMPONENT="${1:?Usage: cxdeploy [-r host] [-n namespace] <component>}"
readonly IMAGE=$("$SCRIPT_DIR/cxconfig" image "$COMPONENT")
readonly DEPLOY=$("$SCRIPT_DIR/cxconfig" deploy "$COMPONENT")
readonly TIMEOUT=$("$SCRIPT_DIR/cxconfig" timeout "$COMPONENT")

IMAGE_AGE=$("$SCRIPT_DIR/image-age" "$IMAGE" 2>/dev/null || echo "unknown")

echo "==> Deploying $COMPONENT"
echo "    Image:      $IMAGE"
echo "    Image age:  $IMAGE_AGE"
echo "    Deployment: $DEPLOY"
echo "    Timeout:    ${TIMEOUT}s"

"$SCRIPT_DIR/deploy-image.sh" -r "$remote_host" -n "$namespace" -t "$TIMEOUT" "$IMAGE" "$DEPLOY"
