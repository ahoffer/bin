#!/bin/bash
set -uo pipefail  # no -e: continue on errors, report all at end

# Build and deploy components (calls cxbuild + cxdeploy for each)
# Must be run from within a project directory (walks up to find pom.xml).
# App is auto-detected from the project root directory name.
#
# Usage: cxship [options] [component...]
#        cxship --all
#        cxship edge
#        cxship edge app graphql
#
# Options:
#   --all               Build and deploy all components
#   -r, --remote HOST   Target k3s node (default: bigfish)
#   -n, --namespace NS  Kubernetes namespace (default: auto from app)

source cxlib.sh
timer_start

usage() {
  sed -n '4,16p' "$0"
  echo -e "\nComponents: $(list_components)"
  exit 0
}

remote_host="bigfish"
namespace=""
build_all=""
declare -a components=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help) usage ;;
    --all) build_all=1; shift ;;
    -r|--remote) remote_host="$2"; shift 2 ;;
    -n|--namespace) namespace="$2"; shift 2 ;;
    -*) echo "Unknown option: $1" >&2; exit 1 ;;
    *) components+=("$1"); shift ;;
  esac
done

# Verify we're in a project directory (walks up tree like git)
require_project_root
acquire_lock "builddeploy"

app=$(cxconfig app)
[[ -z "$namespace" ]] && namespace=$(cxconfig namespace)

# Get available components
mapfile -t all_components < <(cxconfig components)

# Determine which components to build
if [[ -n "$build_all" ]]; then
  components=("${all_components[@]}")
elif [[ ${#components[@]} -eq 0 ]]; then
  echo "Error: Specify components or use --all" >&2
  echo "Available: ${all_components[*]}" >&2
  exit 1
fi

# Validate components
for c in "${components[@]}"; do
  valid_component "$c" all_components || { echo "Error: Unknown component '$c'" >&2; exit 1; }
done

declare -a failures=()

echo "==> Build and Deploy: ${components[*]}"

# Build all components, then deploy all
for component in "${components[@]}"; do
  cxbuild "$component" || failures+=("build:$component")
done

for component in "${components[@]}"; do
  cxdeploy -r "$remote_host" -n "$namespace" "$component" || failures+=("deploy:$component")
done

# Summary
echo
echo "========================================"
echo "Summary"
echo "========================================"

if [[ ${#failures[@]} -eq 0 ]]; then
  timer_end "SUCCESS: ${#components[@]} component(s) built and deployed"
else
  echo "FAILURES: ${#failures[@]} task(s) failed:"
  printf '  - %s\n' "${failures[@]}"
  timer_end "Completed with errors"
  exit 1
fi
