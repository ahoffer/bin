#!/bin/bash
# Web search with Ollama summarization
# Usage: llmsearch "your query"
#        llmsearch --raw "your query"   # show raw results only

set -euo pipefail
source "$(dirname "$0")/ollamalib"

RAW_MODE=false
if [[ "${1:-}" == "--raw" ]]; then
    RAW_MODE=true
    shift
fi

if [[ $# -eq 0 ]]; then
    echo "Usage: llmsearch [--raw] \"your query\"" >&2
    echo "  --raw  Show raw search results without summarization" >&2
    exit 1
fi

query="$*"

# Get search results from DuckDuckGo via ddgr
results=$(ddgr --json --num 5 "$query" 2>/dev/null | jq -r '.[] | "Title: \(.title)\nURL: \(.url)\nSnippet: \(.abstract)\n"')

if [[ -z "$results" ]]; then
    echo "No results found for: $query" >&2
    exit 1
fi

if $RAW_MODE; then
    echo "$results"
    exit 0
fi

# Summarize with Ollama
system="You are a search assistant. Given search results, provide a concise, accurate answer to the query.
Synthesize information from multiple sources. Be direct and factual. If results are insufficient, say so."

prompt="Query: $query

Search results:
$results

Answer the query based on these results:"

ollama_generate "$MODEL_CHAT" "$prompt" "$system"
