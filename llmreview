#!/bin/bash
# Quick code review / first-pass feedback
# Usage: llm-review file.py
#        git diff | llm-review
#        llm-review < code.ts

set -euo pipefail
source "$(dirname "$0")/ollama-lib"
ollama_capture_stdin
ollama_require

# Read input
if [[ $# -gt 0 ]]; then
    input=$(ollama_read_input 6000 "$1" "code")
    context="File: $1"
else
    input=$(ollama_read_input 6000 "" "code")
    context="Code diff or snippet"
fi

system="You are a code reviewer. Review this code for:
1. Bugs or logic errors
2. Security issues (injection, auth, secrets)
3. Performance concerns
4. Style issues (only if severe)

Be concise. List issues as bullet points with line references if visible.
If the code looks fine, say so briefly. Don't nitpick."

echo "Reviewing: $context"
echo "---"
echo "Note: LLM output can be incorrect. Validate before acting."
ollama_generate "$MODEL_CODE" "$input" "$system"
