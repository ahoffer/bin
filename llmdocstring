#!/bin/bash
# Generate docstring/documentation for code
# Usage: llmdocstring < function.py
#        llmdocstring file.ts
#        echo "function code" | llmdocstring --style jsdoc

set -euo pipefail
source "$(dirname "$0")/ollamalib"
ollama_capture_stdin
ollama_require

# Parse args
style=""
file=""
while [[ $# -gt 0 ]]; do
    case "$1" in
        --style) style="$2"; shift 2 ;;
        *) file="$1"; shift ;;
    esac
done

# Read input and auto-detect doc style from extension
if [[ -n "$file" && -f "$file" ]]; then
    input=$(ollama_read_input 3000 "$file" "code")
    if [[ -z "$style" ]]; then
        lang=$(ollama_detect_lang "$file")
        case "$lang" in
            python)     style="google-style python docstring" ;;
            typescript|javascript) style="JSDoc" ;;
            java)       style="Javadoc" ;;
            go)         style="Go doc comment" ;;
            rust)       style="Rust doc comment (///)" ;;
            *)          style="appropriate doc comment" ;;
        esac
    fi
elif [[ -n "${OLLAMA_STDIN:-}" ]]; then
    input=$(ollama_read_input 3000 "" "code")
    style="${style:-appropriate doc comment}"
else
    echo "No code provided" >&2
    exit 1
fi

system="Generate a $style for this code.
Include: brief description, parameters, return value, throws/raises (if any).
Output ONLY the documentation comment, ready to paste above the code.
Be concise but complete."

ollama_generate "$MODEL_CODE" "$input" "$system"
