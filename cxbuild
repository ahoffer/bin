#!/bin/bash
set -euo pipefail

# Build a component's Docker image
#
# This script ONLY builds the image. It does NOT push or deploy.
# After building, use cxdeploy to push the image and restart the pods.
# Must be run from within a project directory (walks up to find pom.xml).
# App is auto-detected from the project root directory name.
#
# Usage: cxbuild <component>
#
# Examples:
#   cxbuild graphql
#   cxbuild edge

source cxlib.sh
timer_start

usage() {
  sed -n '4,15p' "$0"
  echo -e "\nComponents: $(list_components)"
  exit 0
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help) usage ;;
    -*) echo "Unknown option: $1" >&2; exit 1 ;;
    *) break ;;
  esac
done

component="${1:?Usage: cxbuild <component>}"

# Verify we're in a project directory (walks up tree like git)
require_project_root
acquire_lock "build"

project_root=$(cxconfig root)
docker_dir=$(cxconfig dir "$component")

[[ -d "$project_root/docker/$docker_dir" ]] || {
  echo "Error: Directory not found: $project_root/docker/$docker_dir" >&2
  exit 1
}

echo "==> Building $component"
echo "    Project: $project_root"
# shellcheck disable=SC2034  # used via nameref in maven_modules_for_components
components=("$component")
mapfile -t maven_modules < <(maven_modules_for_components components)
for module in "${maven_modules[@]}"; do
  name=$(basename "$module")
  mvn_build "$project_root/$module" "$name"
done
log_file=$(logfile cxbuild "$docker_dir")
echo "==> Docker build: $docker_dir -> $log_file"
if run_logged "$docker_dir" "$log_file" bash -c "cd '$project_root/docker/$docker_dir' && mvn install -DskipTests"; then
  :
else
  exit 1
fi
timer_end "Build complete"
