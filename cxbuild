#!/bin/bash
set -euo pipefail

# Build a component's Docker image
#
# This script ONLY builds the image. It does NOT push or deploy.
# After building, use cxdeploy to push the image and restart the pods.
# Must be run from within a project directory (walks up to find pom.xml).
#
# Usage: cxbuild [-a app] <component>
#
# Options:
#   -a, --app APP       Application: cx or marrs (default: auto-detect)
#
# Examples:
#   cxbuild graphql
#   cxbuild -a marrs edge

source cx-lib.sh

usage() {
  sed -n '3,16p' "$0"
  echo -e "\nComponents: $(cx_list_components "${app:-}")"
  exit 0
}

app=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help) usage ;;
    -a|--app) app="$2"; shift 2 ;;
    -*) echo "Unknown option: $1" >&2; exit 1 ;;
    *) break ;;
  esac
done

component="${1:?Usage: cxbuild [-a app] <component>}"

# Build cxconfig args
cfg_args=()
cx_cfg_args cfg_args "$app"

project_root=$(cxconfig "${cfg_args[@]}" root)

docker_dir=$(cxconfig "${cfg_args[@]}" dir "$component")

[[ -d "$project_root/docker/$docker_dir" ]] || {
  echo "Error: Directory not found: $project_root/docker/$docker_dir" >&2
  exit 1
}

# Component-specific pre-build steps
prebuild() {
  case "$component" in
    graphql)
      cx_mvn_build "$project_root/frontend/graphql" "graphql"
      ;;
    app)
      cx_mvn_build "$project_root/frontend/app" "app"
      ;;
    edge|redirect|video-streaming)
      cx_mvn_build "$project_root/backend" "backend"
      cx_mvn_build "$project_root/distributions" "distributions"
      ;;
    docs)
      cx_mvn_build "$project_root/docs" "docs"
      ;;
  esac
}

echo "==> Building $component"
echo "    App: $(cxconfig "${cfg_args[@]}" app)"
echo "    Project: $project_root"
echo "    Docker: $project_root/docker/$docker_dir"
prebuild
echo "==> Docker build: $docker_dir"
(cd "$project_root/docker/$docker_dir" && mvn install -DskipTests)
echo "==> Build complete"
