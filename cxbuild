#!/bin/bash
set -euo pipefail

# Build a component's Docker image
#
# This script ONLY builds the image. It does NOT push or deploy.
# After building, use cxdeploy to push the image and restart the pods.
#
# Usage: cxbuild [-a app] [-p project_root] <component>
#
# Options:
#   -a, --app APP       Application: cx or marrs (default: auto-detect from project root)
#   -p, --project DIR   Project root (default: auto from app)
#
# Examples:
#   cxbuild graphql              # Build graphql component
#   cxbuild -p /builds/marrs     # Build from alternate project
#   cxbuild -a marrs edge        # Build edge for marrs

readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

usage() {
  sed -n '3,17p' "$0"
  local app_flag=""
  [[ -n "${app:-}" ]] && app_flag="-a $app"
  echo -e "\nComponents: $("$SCRIPT_DIR/cxconfig" $app_flag components | tr '\n' ' ')"
  exit 0
}

app=""
project_root=""
while [[ $# -gt 0 && "$1" == -* ]]; do
  case "$1" in
    -h|--help) usage ;;
    -a|--app) app="$2"; shift 2 ;;
    -p|--project) project_root="$2"; shift 2 ;;
    *) echo "Unknown option: $1" >&2; exit 1 ;;
  esac
done

# Build cxconfig args
cfg_args=()
[[ -n "$app" ]] && cfg_args+=(-a "$app")

# Get project root: explicit flag > auto from app
if [[ -z "$project_root" ]]; then
  project_root=$("$SCRIPT_DIR/cxconfig" "${cfg_args[@]}" root)
fi

readonly COMPONENT="${1:?Usage: cxbuild [-a app] [-p project_root] <component>}"
readonly PROJECT_ROOT="$project_root"
readonly DOCKER_DIR=$("$SCRIPT_DIR/cxconfig" "${cfg_args[@]}" dir "$COMPONENT")

if [[ ! -d "$PROJECT_ROOT/docker/$DOCKER_DIR" ]]; then
  echo "Error: Directory not found: $PROJECT_ROOT/docker/$DOCKER_DIR" >&2
  exit 1
fi

# Run maven build in a directory
mvn_build() {
  local dir="$1"
  if [[ ! -d "$dir" ]]; then
    echo "Error: Directory not found: $dir" >&2
    exit 1
  fi
  echo "==> Maven build $dir"
  (cd "$dir" && mvn clean install -DskipTests -T6)
}

# Component-specific pre-build steps
prebuild() {
  case "$COMPONENT" in
    graphql)
      mvn_build "$PROJECT_ROOT/frontend/graphql"
      ;;
    app)
      mvn_build "$PROJECT_ROOT/frontend/app"
      ;;
    edge|redirect|video-streaming)
      mvn_build "$PROJECT_ROOT/backend"
      mvn_build "$PROJECT_ROOT/distributions"
      ;;
    docs)
      mvn_build "$PROJECT_ROOT/docs"
      ;;
  esac
}

echo "==> Building $COMPONENT"
echo "    App $("$SCRIPT_DIR/cxconfig" "${cfg_args[@]}" app)"
echo "    Project root $PROJECT_ROOT"
echo "    Docker $PROJECT_ROOT/docker/$DOCKER_DIR"
prebuild
echo "==> Docker build $PROJECT_ROOT/docker/$DOCKER_DIR"
(cd "$PROJECT_ROOT/docker/$DOCKER_DIR" && mvn install -DskipTests)
echo "==> Build complete"
