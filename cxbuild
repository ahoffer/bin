#!/bin/bash
set -euo pipefail

# Build a component's Docker image
#
# This script ONLY builds the image. It does NOT push or deploy.
# After building, use cxdeploy to push the image and restart the pods.
# Must be run from within a project directory (walks up to find pom.xml).
# App is auto-detected from the project root directory name.
#
# Usage: cxbuild <component>
#
# Examples:
#   cxbuild graphql
#   cxbuild edge

source cxlib.sh

usage() {
  sed -n '4,15p' "$0"
  echo -e "\nComponents: $(list_components)"
  exit 0
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help) usage ;;
    -*) echo "Unknown option: $1" >&2; exit 1 ;;
    *) break ;;
  esac
done

component="${1:?Usage: cxbuild <component>}"

require_project_root
acquire_lock "build"

mapfile -t all_components < <(cxconfig components)
valid_component "$component" all_components || { err_msg "Unknown component '$component'"; exit 1; }

project_root=$(cxconfig root)
build_maven_modules "$project_root" "$component" || exit 1
docker_build "$project_root" "$component" || exit 1
