#!/bin/bash
set -euo pipefail

# Build a component's Docker image
#
# This script ONLY builds the image. It does NOT push or deploy.
# After building, use cxdeploy to push the image and restart the pods.
# Must be run from within a project directory (walks up to find pom.xml).
# App is auto-detected from the project root directory name.
#
# Usage: cxbuild <component>
#
# Examples:
#   cxbuild graphql
#   cxbuild edge

source cxlib.sh
timer_start

usage() {
  sed -n '4,15p' "$0"
  echo -e "\nComponents: $(cx_list_components)"
  exit 0
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help) usage ;;
    -*) echo "Unknown option: $1" >&2; exit 1 ;;
    *) break ;;
  esac
done

component="${1:?Usage: cxbuild <component>}"

# Verify we're in a project directory (walks up tree like git)
cx_require_project_root

project_root=$(cxconfig root)
docker_dir=$(cxconfig dir "$component")

[[ -d "$project_root/docker/$docker_dir" ]] || {
  echo "Error: Directory not found: $project_root/docker/$docker_dir" >&2
  exit 1
}

# Component-specific pre-build steps
prebuild() {
  case "$component" in
    graphql)
      cx_mvn_build "$project_root/frontend/graphql" "graphql"
      ;;
    app)
      cx_mvn_build "$project_root/frontend/app" "app"
      ;;
    edge|redirect|video-streaming)
      cx_mvn_build "$project_root/backend" "backend"
      cx_mvn_build "$project_root/distributions" "distributions"
      ;;
    docs)
      cx_mvn_build "$project_root/docs" "docs"
      ;;
  esac
}

echo "==> Building $component"
echo "    App: $(cxconfig app)"
echo "    Project: $project_root"
echo "    Docker: $project_root/docker/$docker_dir"
prebuild
echo "==> Docker build: $docker_dir"
log_file=$(logfile cxbuild "$docker_dir")
if run_logged "$docker_dir" "$log_file" bash -c "cd '$project_root/docker/$docker_dir' && mvn install -DskipTests"; then
  :
else
  exit 1
fi
timer_end "Build complete"
