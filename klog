#!/bin/bash
# klog - Follow logs for a pod matching a partial name
#
# Usage: klog <partial-name> [kubectl logs options...]
# Examples:
#   klog nginx              # follow logs for first pod matching 'nginx'
#   klog frontend --tail=100  # follow logs, starting from last 100 lines
#   klog myapp -n my-namespace  # search in specific namespace

set -e

if [[ $# -lt 1 ]]; then
    echo "Usage: klog <partial-pod-name> [kubectl logs options...]"
    echo ""
    echo "Examples:"
    echo "  klog nginx              # follow logs for pod matching 'nginx'"
    echo "  klog web --tail=50      # follow, starting from last 50 lines"
    echo "  klog app -n prod        # search in 'prod' namespace"
    exit 1
fi

PATTERN="$1"
shift

# Extract namespace from remaining args if provided
NAMESPACE_ARGS=""
REMAINING_ARGS=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        -n|--namespace)
            NAMESPACE_ARGS="-n $2"
            shift 2
            ;;
        -n=*|--namespace=*)
            NAMESPACE_ARGS="$1"
            shift
            ;;
        *)
            REMAINING_ARGS+=("$1")
            shift
            ;;
    esac
done

# Find matching pods
PODS=$(kubectl get pods $NAMESPACE_ARGS --no-headers 2>/dev/null | grep -i -- "$PATTERN" | awk '{print $1}')

if [[ -z "$PODS" ]]; then
    echo "No pods found matching '$PATTERN'"
    exit 1
fi

POD_COUNT=$(echo "$PODS" | wc -l)

if [[ $POD_COUNT -gt 1 ]]; then
    echo "Error: Ambiguous match - multiple pods match '$PATTERN':" >&2
    echo "$PODS" >&2
    exit 1
fi

POD="$PODS"

echo "â†’ kubectl logs $NAMESPACE_ARGS $POD -f ${REMAINING_ARGS[*]}"
kubectl logs $NAMESPACE_ARGS "$POD" -f "${REMAINING_ARGS[@]}"
