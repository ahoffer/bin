#!/usr/bin/env bash
set -e  # Exit on any error

# 1) Format licenses and code
mvn license:format
mvn com.spotify.fmt:fmt-maven-plugin:format -T1C

# 2) Ensure Yarn 4.5.1 via Corepack
corepack enable
if ! yarn -v | grep -Eq '^v?4\.5\.1$'; then
  corepack prepare yarn@4.5.1 --activate
fi

# 3) Default: do a clean build, unless --dirty or -dirty is passed
RUN_CLEAN=true
for arg in "$@"; do
  if [[ "$arg" == "--dirty" || "$arg" == "-dirty" ]]; then
    RUN_CLEAN=false
    break
  fi
done

# 4) (DELETED)

# 5) Run Maven with or without clean, passing all original args (except "--dirty"/"-dirty")
if $RUN_CLEAN; then
  echo "→ Running: mvn clean install -DskipTests $*"
  mvn clean install -DskipTests "$@"
else
  echo "→ Running: mvn install -DskipTests $*"
  mvn install -DskipTests "$@"
fi

