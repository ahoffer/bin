#!/usr/bin/env bash
# qb â€“ quick build helper
# Formats code, ensures correct Yarn version, and builds with Maven

set -euo pipefail

# Format code and licenses
echo "Formatting code and licenses..."
mvn license:format -T1C
mvn com.spotify.fmt:fmt-maven-plugin:format -T1C

# Ensure Yarn 4.5.1 via Corepack
echo "Ensuring Yarn 4.5.1..."
corepack enable
if ! yarn -v | grep -Eq '^v?4\.5\.1$'; then
    corepack prepare yarn@4.5.1 --activate
fi

# Parse command line arguments
clean=true
for arg in "$@"; do
    case "$arg" in
        --dirty|-dirty)
            clean=false
            ;;
    esac
done

# Build with Maven
echo "***************************************************"
if [[ "$clean" == true ]]; then
    echo "Executing: mvn clean install -DskipTests"
    echo "***************************************************"
    mvn clean install -DskipTests
else
    echo "Executing: mvn install -DskipTests"
    echo "***************************************************"
    mvn install -DskipTests
fi

