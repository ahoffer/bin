#!/bin/bash
# version 1.0.0
# Downloaded a zip file of certs from https://public.cyber.mil/announcement/new-dod-pki-cas-released/
# The file was named unclass-certificates_pkcs7_DoD.zip
# Tested this once or twice on Ubuntu 24
# YMMV

set +e

ZIPFILE="$1"
if [[ -z "$ZIPFILE" ]]; then
  echo "Usage: $0 <DoD_cert_bundle.zip>" >&2
  exit 1
fi
if [[ ! -f "$ZIPFILE" ]]; then
  echo "ERROR: '$ZIPFILE' not found." >&2
  exit 1
fi

# 1) Unzip into a temp dir
TEMPDIR=$(mktemp -d -t dod_certs.XXXX)
echo "[*] Extracting '$ZIPFILE' → $TEMPDIR"
unzip -q "$ZIPFILE" -d "$TEMPDIR" || {
  echo "ERROR: unzip failed" >&2
  exit 1
}

# 2) Find .p7b files
mapfile -t P7B_FILES < <(find "$TEMPDIR" -type f -iname '*.p7b')
echo "[*] Found ${#P7B_FILES[@]} .p7b files"
if (( ${#P7B_FILES[@]} == 0 )); then
  echo "ERROR: no .p7b files" >&2
  exit 1
fi

# 3) Prepare destination (system CA dir)
DEST_DIR="/usr/local/share/ca-certificates/dod"
echo "[*] Creating $DEST_DIR (requires sudo)"
sudo mkdir -p "$DEST_DIR" || {
  echo "ERROR: cannot mkdir $DEST_DIR" >&2
  exit 1
}

# 4) Convert & split
CERT_FILES=()
for P7B in "${P7B_FILES[@]}"; do
  bn=$(basename "$P7B")
  echo "[*] Processing $bn"

  if [[ ! -s "$P7B" ]]; then
    echo "  WARN: $bn empty, skipping" >&2
    continue
  fi

  # detect DER vs PEM
  if grep -q -- "-----BEGIN" "$P7B"; then
    INFORM="PEM"
  else
    INFORM="DER"
  fi
  echo "  → format: $INFORM"

  COMBINED="$TEMPDIR/${bn%.p7b}.pem"
  echo "  → openssl pkcs7 -inform $INFORM"
  openssl pkcs7 -print_certs -in "$P7B" -inform "$INFORM" \
    -out "$COMBINED" 2>/dev/null || {
    echo "  ERROR: openssl conversion failed for $bn" >&2
    continue
  }

  # split each cert
  idx=0
  while read -r line; do
    if [[ "$line" == "-----BEGIN CERTIFICATE-----" ]]; then
      ((idx++))
      out="$TEMPDIR/${bn%.p7b}_$idx.crt"
      CERT_FILES+=("$out")
      echo "$line" > "$out"
    elif (( idx > 0 )); then
      echo "$line" >> "$out"
    fi
  done < "$COMBINED"

  echo "  → extracted $idx cert(s) from $bn"
done

# 5) Install each .crt with sudo
echo "[*] Installing ${#CERT_FILES[@]} certificates to $DEST_DIR"
installed=0
for crt in "${CERT_FILES[@]}"; do
  base=$(basename "$crt")
  echo "  → sudo cp $base"
  sudo cp "$crt" "$DEST_DIR/" && ((installed++)) || {
    echo "  ERROR: failed to copy $base" >&2
  }
done

if (( installed == 0 )); then
  echo "ERROR: no certs were installed" >&2
  exit 1
fi

# 6) Update trust store
echo "[*] Running sudo update-ca-certificates"
sudo update-ca-certificates || {
  echo "ERROR: update-ca-certificates failed" >&2
  exit 1
}

# 7) Verify with OpenSSL
echo "[*] Verifying TLS to www.defense.gov"
verify=$(echo | openssl s_client -connect www.defense.gov:443 -CApath /etc/ssl/certs 2>/dev/null \
  | grep -c "Verify return code: 0")
if (( verify > 0 )); then
  echo "SUCCESS: DoD certs installed and trust verified"
  exit 0
else
  echo "ERROR: TLS verification failed" >&2
  exit 1
fi

