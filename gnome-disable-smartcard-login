#!/usr/bin/env bash
set -euo pipefail

#------------------------------------------------------------------------
# v2.0
#
# On Ubuntu 24.04 + GNOME 46, force GDM3 to show only the password
# prompt at login (even with Wayland disabled), while keeping smartcard
# auth working in-session.
#------------------------------------------------------------------------

# 0) Must be run with sudo
if (( EUID != 0 )); then
  echo "âš ï¸  Please run with sudo:  sudo $0"
  exit 1
fi

GDM_CONF=/etc/gdm3/custom.conf

# 1) Disable Wayland in GDM3
if ! grep -q '^WaylandEnable=false' "$GDM_CONF"; then
  if grep -q '^\[daemon\]' "$GDM_CONF"; then
    sed -i '/^\[daemon\]/a WaylandEnable=false' "$GDM_CONF"
  else
    # ensure we have a [daemon] block
    printf "[daemon]\nWaylandEnable=false\n" >> "$GDM_CONF"
  fi
else
  sed -ri 's/^#?WaylandEnable=.*/WaylandEnable=false/' "$GDM_CONF"
fi

# 2) Ensure the GDM dconf-profile exists
cat > /etc/dconf/profile/gdm << 'EOF'
user-db:user
system-db:gdm
EOF

# 3) Ensure the override directory
mkdir -p /etc/dconf/db/gdm.d

# 4) Write our login-screen override
cat > /etc/dconf/db/gdm.d/00-custom-login << 'EOF'
[org/gnome/login-screen]
# disable the â€œInsert smart-cardâ€ UI
enable-smartcard-authentication=false
# always show the password prompt
enable-password-authentication=true
EOF

# 5) Rebuild the system dconf database
dconf update

# 6) Point GDMâ€™s â€œgdm-smartcardâ€ PAM link at the fallback password profile
update-alternatives --set gdm-smartcard /etc/pam.d/gdm-smartcard-sssd-or-password

# 7) Restart GDM3 so it picks everything up
systemctl restart gdm3

echo
echo "ðŸ”§ Configuration applied; now verifyingâ€¦"
echo

PASS=0
FAIL=0

# â€” Verify Wayland disabled â€”
if grep -q '^WaylandEnable=false' "$GDM_CONF"; then
  echo "âœ… Wayland is disabled in $GDM_CONF"
  ((PASS++))
else
  echo "âŒ WaylandEnable=false *not* found in $GDM_CONF"
  ((FAIL++))
fi

# â€” Verify dconf profile â€”
if [[ -f /etc/dconf/profile/gdm ]]; then
  echo "âœ… /etc/dconf/profile/gdm exists"
  ((PASS++))
else
  echo "âŒ /etc/dconf/profile/gdm is missing"
  ((FAIL++))
fi

# â€” Verify dconf override â€”
if grep -q 'enable-smartcard-authentication=false' /etc/dconf/db/gdm.d/00-custom-login \
   && grep -q 'enable-password-authentication=true' /etc/dconf/db/gdm.d/00-custom-login; then
  echo "âœ… dconf override file /etc/dconf/db/gdm.d/00-custom-login is correct"
  ((PASS++))
else
  echo "âŒ dconf override file /etc/dconf/db/gdm.d/00-custom-login is incorrect or missing"
  ((FAIL++))
fi

# â€” Verify PAM alternative â€”
CURRENT=$(update-alternatives --query gdm-smartcard | awk '/Value: /{print $2}')
if [[ "$CURRENT" == "/etc/pam.d/gdm-smartcard-sssd-or-password" ]]; then
  echo "âœ… gdm-smartcard alternative points to password fallback"
  ((PASS++))
else
  echo "âŒ gdm-smartcard alternative is set to '$CURRENT'"
  ((FAIL++))
fi

echo
echo "âœ”ï¸  Passed: $PASS checks"
echo "âŒ  Failed: $FAIL checks"
echo

if (( FAIL == 0 )); then
  echo "All checks passed. Please log out or reboot to confirm you now get only a password prompt."
else
  echo "One or more checks failed. Double-check the scriptâ€™s output and paths."
fi
