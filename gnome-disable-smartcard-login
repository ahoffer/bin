#!/usr/bin/env bash
set -euo pipefail

#------------------------------------------------------------------------
# On Ubuntu 24.04 + GNOME 46, disable the smartcard prompt *only* in
# the GDM greeter (keeping in-session pcscd/NSS smartcard logins intact),
# even when Wayland is turned off.
#------------------------------------------------------------------------

# 0) Must be run as root
if (( EUID != 0 )); then
  echo "⚠️  Please run with sudo:  sudo $0"
  exit 1
fi

GDM_CONF=/etc/gdm3/custom.conf
PROFILE=/etc/dconf/profile/gdm
OVERRIDE_DIR=/etc/dconf/db/gdm.d
OVERRIDE_FILE=$OVERRIDE_DIR/00-custom-login
ALT_NAME=gdm-smartcard
ALT_TARGET=/etc/pam.d/gdm-smartcard-sssd-or-password

# 1) Disable Wayland in GDM3 if not already
if grep -q '^[[:space:]]*WaylandEnable=false' "$GDM_CONF"; then
  echo "→ Wayland already disabled in $GDM_CONF"
elif grep -q '^[[:space:]]*WaylandEnable=' "$GDM_CONF"; then
  sed -ri 's|^[[:space:]]*WaylandEnable=.*|WaylandEnable=false|' "$GDM_CONF"
  echo "→ Updated WaylandEnable to false in $GDM_CONF"
else
  sed -i '/^\[daemon\]/a WaylandEnable=false' "$GDM_CONF"
  echo "→ Inserted WaylandEnable=false under [daemon] in $GDM_CONF"
fi

# 2) Ensure the GDM dconf-profile exists and is correct
read -r -d '' DESIRED_PROFILE << 'EOF'
user-db:user
system-db:gdm
EOF

if [[ ! -f $PROFILE ]] || ! cmp -s <(printf "%s\n" "$DESIRED_PROFILE") "$PROFILE"; then
  printf "%s\n" "$DESIRED_PROFILE" > "$PROFILE"
  echo "→ Wrote $PROFILE"
else
  echo "→ $PROFILE is already correct"
fi

# 3) Ensure the override directory
mkdir -p "$OVERRIDE_DIR"

# 4) Write (or update) our login-screen override
read -r -d '' DESIRED_OVERRIDE << 'EOF'
[org/gnome/login-screen]
# disable the “Insert smart-card” UI
enable-smartcard-authentication=false
# always show the password prompt
enable-password-authentication=true
EOF

if [[ ! -f $OVERRIDE_FILE ]] || ! cmp -s <(printf "%s\n" "$DESIRED_OVERRIDE") "$OVERRIDE_FILE"; then
  printf
