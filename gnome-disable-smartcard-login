#!/usr/bin/env bash
set -euo pipefail

#------------------------------------------------------------------------
# fix-gdm-smartcard.sh
#
# On Ubuntu 24.04 + GNOME 46 force GDM to stop requiring a smartcard
# at the greeter while still keeping pcscd/NSS alive in-session.
#------------------------------------------------------------------------

# 0) Must be run with sudo (you’ll be prompted once)
if (( EUID != 0 )); then
  echo "⚠️  Please run with sudo:  sudo $0"
  exit 1
fi

# 1) Ensure the GDM dconf-profile exists
cat > /etc/dconf/profile/gdm << 'EOF'
user-db:user
system-db:gdm
EOF

# 2) Ensure the override directory
mkdir -p /etc/dconf/db/gdm.d

# 3) Write our login-screen override
cat > /etc/dconf/db/gdm.d/00-custom-login << 'EOF'
[org/gnome/login-screen]
# disable the “Insert smart-card” UI
enable-smartcard-authentication=false
# always show the password prompt
enable-password-authentication=true
EOF

# 4) Rebuild the system dconf database
dconf update

# 5) Point GDM’s “gdm-smartcard” PAM link at the fallback (password) profile
update-alternatives --set gdm-smartcard /etc/pam.d/gdm-smartcard-sssd-or-password

# 6) Restart GDM so it picks everything up
systemctl restart gdm

echo "✅ Done! GDM will now show the password field only."

