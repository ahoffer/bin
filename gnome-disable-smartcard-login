#!/usr/bin/env bash
set -euo pipefail

#------------------------------------------------------------------------
# v3
# On Ubuntu 24.04 + GNOME 46 force GDM to stop requiring a smartcard
# at the greeter, even when Wayland is disabled, while still keeping
# pcscd/NSS alive in-session.
#------------------------------------------------------------------------

# 1) Disable Wayland in GDM3 (so we know GDM is running X11)
GDM_CONF=/etc/gdm3/custom.conf
if ! grep -q '^WaylandEnable=' "$GDM_CONF"; then
  # inject under [daemon] if not already present
  sed -i '/^\[daemon\]/a WaylandEnable=false' "$GDM_CONF"
else
  # ensure it's set to false
  sed -ri 's/^#?WaylandEnable=.*/WaylandEnable=false/' "$GDM_CONF"
fi

# 2) Ensure the GDM dconf-profile exists
cat > /etc/dconf/profile/gdm << 'EOF'
user-db:user
system-db:gdm
EOF

# 3) Ensure the override directory
mkdir -p /etc/dconf/db/gdm.d

# 4) Write our login-screen override
cat > /etc/dconf/db/gdm.d/00-custom-login << 'EOF'
[org/gnome/login-screen]
# disable the “Insert smart-card” UI
enable-smartcard-authentication=false
# always show the password prompt
enable-password-authentication=true
EOF

# 5) Rebuild the system dconf database
dconf update

# 6) Point GDM’s “gdm-smartcard” PAM link at the fallback (password) profile
update-alternatives --set gdm-smartcard /etc/pam.d/gdm-smartcard-sssd-or-password

# 7) Restart GDM3 so it picks everything up
systemctl restart gdm3

echo "✅ Done! Wayland is disabled and GDM will now show only the password field."
