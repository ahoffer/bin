#!/usr/bin/env bash
#
# Docker/Container Process Status
#
# Display container status with enhanced formatting for both docker and nerdctl.
# Supports filtering by container name and automatically handles sudo if needed.

set -euo pipefail

TAB=$'\t'

# Get base CLI name
CLI=$(container-cli)

# Test if we need sudo
if $CLI ps &>/dev/null; then
  CONTAINER_CLI="$CLI"
elif sudo -n $CLI ps &>/dev/null; then
  CONTAINER_CLI="sudo $CLI"
else
  echo "Error: cannot run $CLI, even with sudo" >&2
  exit 1
fi

# Choose format strings
if [[ "$CLI" == "docker" ]]; then
  BASE_FORMAT="table {{.Names}}${TAB}{{.Status}}${TAB}{{.Size}}"
  FILTER_FORMAT="table {{.Names}}${TAB}{{.Image}}${TAB}{{.CreatedAt}}${TAB}{{.Size}}"
else
  BASE_FORMAT="{{.Names}}${TAB}{{.Status}}${TAB}{{.Size}}"
  FILTER_FORMAT="{{.Names}}${TAB}{{.Image}}${TAB}{{.CreatedAt}}${TAB}{{.Size}}"
fi

# Main logic
if [[ $# -eq 0 ]]; then
  $CONTAINER_CLI ps --format "$BASE_FORMAT" | tail -n +2 | sort
else
  FILTER="$1"
  $CONTAINER_CLI ps --format "$FILTER_FORMAT" | grep -i -- "$FILTER" | tail -n +2 | sort
fi

