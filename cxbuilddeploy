#!/bin/bash
set -uo pipefail  # no -e: continue on errors, report all at end

# Build and deploy components (unattended)
# Must be run from within a project directory (walks up to find pom.xml).
# App is auto-detected from the project root directory name.
#
# Usage: cxbuild-deploy-all [options] [component...]
#        cxbuild-deploy-all --all
#        cxbuild-deploy-all edge
#        cxbuild-deploy-all edge app graphql
#
# Options:
#   --all               Build and deploy all components
#   -r, --remote HOST   Target k3s node (default: bigfish)
#   -n, --namespace NS  Kubernetes namespace (default: auto from app)

source cxlib.sh
timer_start

usage() {
  sed -n '4,16p' "$0"
  echo -e "\nComponents: $(cx_list_components)"
  exit 0
}

remote_host="bigfish"
namespace=""
build_all=""
declare -a components=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help) usage ;;
    --all) build_all=1; shift ;;
    -r|--remote) remote_host="$2"; shift 2 ;;
    -n|--namespace) namespace="$2"; shift 2 ;;
    -*) echo "Unknown option: $1" >&2; exit 1 ;;
    *) components+=("$1"); shift ;;
  esac
done

# Verify we're in a project directory (walks up tree like git)
cx_require_project_root

# Get config values
app=$(cxconfig app)
project_root=$(cxconfig root)
[[ -z "$namespace" ]] && namespace=$(cxconfig namespace)

# Get available components
mapfile -t all_components < <(cxconfig components)

# Determine which components to build
if [[ -n "$build_all" ]]; then
  components=("${all_components[@]}")
elif [[ ${#components[@]} -eq 0 ]]; then
  echo "Error: Specify components or use --all" >&2
  echo "Available: ${all_components[*]}" >&2
  exit 1
fi

# Validate components
for c in "${components[@]}"; do
  cx_valid_component "$c" all_components || { echo "Error: Unknown component '$c'" >&2; exit 1; }
done

# Track failures
declare -a failures=()

echo "==> Build and Deploy"
echo "    App: $app"
echo "    Project: $project_root"
echo "    Remote: $remote_host"
echo "    Namespace: $namespace"
echo "    Components: ${components[*]}"

# Determine which Maven modules need building
needs_backend="" needs_graphql="" needs_app="" needs_docs=""
for c in "${components[@]}"; do
  case "$c" in
    edge|redirect|video-streaming) needs_backend=1 ;;
    graphql) needs_graphql=1 ;;
    app) needs_app=1 ;;
    docs) needs_docs=1 ;;
  esac
done

phase_header "1/4" "Building source code (Maven)"

jobs_init
[[ -n "$needs_backend" ]] && {
  ( cx_mvn_build "$project_root/backend" "backend" && \
    cx_mvn_build "$project_root/distributions" "distributions" ) &
  _JOB_PIDS[backend]=$!
}
[[ -n "$needs_graphql" ]] && { cx_mvn_build "$project_root/frontend/graphql" "graphql" & _JOB_PIDS[graphql]=$!; }
[[ -n "$needs_app" ]] && { cx_mvn_build "$project_root/frontend/app" "app" & _JOB_PIDS[app]=$!; }
[[ -n "$needs_docs" ]] && { cx_mvn_build "$project_root/docs" "docs" & _JOB_PIDS[docs]=$!; }
jobs_wait failures "maven"

phase_header "2/4" "Docker build"

jobs_init
for component in "${components[@]}"; do
  docker_dir=$(cxconfig dir "$component")
  job_start "$component" "$(logfile_simple cxbuild-docker "$component")" \
    bash -c "cd '$project_root/docker/$docker_dir' && mvn install -DskipTests"
done
jobs_wait failures "docker"

phase_header "3/4" "Push images to k3s"

jobs_init
for component in "${components[@]}"; do
  image=$(cxconfig image "$component")
  job_start "$component" "$(logfile_simple cxbuild-push "$component")" \
    k3s-push-image -H "$remote_host" "$image"
done
jobs_wait failures "push"
phase_done "3/4"

phase_header "4/4" "Deploy to pods"

jobs_init
for component in "${components[@]}"; do
  deploy=$(cxconfig deploy "$component")
  timeout_val=$(cxconfig timeout "$component")
  image=$(cxconfig image "$component")
  job_start "$component" "$(logfile_simple cxbuild-deploy "$component")" \
    bash -c "k8s-restart-deploy -n '$namespace' -t '${timeout_val}s' '$deploy' && \
             k8s-verify-image -n '$namespace' -r '$remote_host' -t '$timeout_val' '$image' '$deploy'"
done
jobs_wait failures "deploy"
phase_done "4/4"

# Summary
echo
echo "========================================"
echo "Summary"
echo "========================================"

if [[ ${#failures[@]} -eq 0 ]]; then
  timer_end "SUCCESS: ${#components[@]} component(s) built and deployed"
else
  echo "FAILURES: ${#failures[@]} task(s) failed:"
  printf '  - %s\n' "${failures[@]}"
  echo -e "\nLogs: /tmp/cxbuild-deploy-*.log"
  timer_end "Completed with errors"
  exit 1
fi
