#!/bin/bash
set -uo pipefail  # no -e: continue on errors, report all at end

# Build and deploy components (unattended)
# Must be run from within a project directory (walks up to find pom.xml).
# App is auto-detected from the project root directory name.
#
# Usage: cxbuild-deploy-all [options] [component...]
#        cxbuild-deploy-all --all
#        cxbuild-deploy-all edge
#        cxbuild-deploy-all edge app graphql
#
# Options:
#   --all               Build and deploy all components
#   -r, --remote HOST   Target k3s node (default: bigfish)
#   -n, --namespace NS  Kubernetes namespace (default: auto from app)

source cxlib.sh
timer_start

usage() {
  sed -n '4,16p' "$0"
  echo -e "\nComponents: $(list_components)"
  exit 0
}

remote_host="bigfish"
namespace=""
build_all=""
declare -a components=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help) usage ;;
    --all) build_all=1; shift ;;
    -r|--remote) remote_host="$2"; shift 2 ;;
    -n|--namespace) namespace="$2"; shift 2 ;;
    -*) echo "Unknown option: $1" >&2; exit 1 ;;
    *) components+=("$1"); shift ;;
  esac
done

# Verify we're in a project directory (walks up tree like git)
require_project_root
acquire_lock "builddeploy"

# Get config values
app=$(cxconfig app)
project_root=$(cxconfig root)
[[ -z "$namespace" ]] && namespace=$(cxconfig namespace)

# Get available components
mapfile -t all_components < <(cxconfig components)

# Determine which components to build
if [[ -n "$build_all" ]]; then
  components=("${all_components[@]}")
elif [[ ${#components[@]} -eq 0 ]]; then
  echo "Error: Specify components or use --all" >&2
  echo "Available: ${all_components[*]}" >&2
  exit 1
fi

# Validate components
for c in "${components[@]}"; do
  valid_component "$c" all_components || { echo "Error: Unknown component '$c'" >&2; exit 1; }
done

# Track failures
declare -a failures=()

echo "==> Build and Deploy"
echo "    App: $app"
echo "    Project: $project_root"
echo "    Remote: $remote_host"
echo "    Namespace: $namespace"
echo "    Components: ${components[*]}"

run_component_jobs() {
  local prefix="$1"
  local log_prefix="$2"
  local job_fn="$3"
  jobs_init
  for component in "${components[@]}"; do
    job_start "$component" "$(logfile_simple "$log_prefix" "$component")" "$job_fn" "$component"
  done
  jobs_wait failures "$prefix"
}

docker_job() {
  local component="$1"
  local docker_dir
  docker_dir=$(cxconfig dir "$component")
  bash -c "cd '$project_root/docker/$docker_dir' && mvn install -DskipTests"
}

push_job() {
  local component="$1"
  local image
  image=$(cxconfig image "$component")
  k3s-push-image -H "$remote_host" "$image"
}

deploy_job() {
  local component="$1"
  local deploy timeout_val image
  deploy=$(cxconfig deploy "$component")
  timeout_val=$(cxconfig timeout "$component")
  image=$(cxconfig image "$component")
  k8s-restart-deploy -n "$namespace" -t "${timeout_val}s" "$deploy" && \
    k8s-verify-image -n "$namespace" -r "$remote_host" -t "$timeout_val" "$image" "$deploy"
}

phase_header "1/4" "Building source code (Maven)"

mapfile -t maven_modules < <(maven_modules_for_components components)
jobs_init
for module in "${maven_modules[@]}"; do
  name=$(basename "$module")
  mvn_build "$project_root/$module" "$name" &
  _JOB_PIDS[$name]=$!
done
jobs_wait failures "maven"

phase_header "2/4" "Docker build"
run_component_jobs "docker" "cxbuild-docker" docker_job
phase_done "2/4"

phase_header "3/4" "Push images to k3s"
run_component_jobs "push" "cxbuild-push" push_job
phase_done "3/4"

phase_header "4/4" "Deploy to pods"
run_component_jobs "deploy" "cxbuild-deploy" deploy_job
phase_done "4/4"

# Summary
echo
echo "========================================"
echo "Summary"
echo "========================================"

if [[ ${#failures[@]} -eq 0 ]]; then
  timer_end "SUCCESS: ${#components[@]} component(s) built and deployed"
else
  echo "FAILURES: ${#failures[@]} task(s) failed:"
  printf '  - %s\n' "${failures[@]}"
  echo -e "\nLogs: /tmp/cxbuild-deploy-*.log"
  timer_end "Completed with errors"
  exit 1
fi
