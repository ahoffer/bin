#!/bin/bash
# Generate regex from description
# Usage: llmregex "email address"
#        llmregex "ISO date format" --flavor python
#        llmregex "phone number with optional country code"

set -euo pipefail
source "$(dirname "$0")/ollamalib.sh"
ollama_require

# Parse args
flavor="PCRE/JavaScript"
desc_parts=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        --flavor) flavor="$2"; shift 2 ;;
        --) shift; desc_parts+=("$@"); break ;;
        *) desc_parts+=("$1"); shift ;;
    esac
done

desc="${desc_parts[*]}"
if [[ -z "${desc// }" ]]; then
    echo "Usage: llmregex \"description\" [--flavor python|js|go|...]" >&2
    exit 1
fi

system="Generate a regex pattern for: $desc
Flavor: $flavor

Output format:
PATTERN: <the regex>
EXPLANATION: <brief explanation of each part>
EXAMPLES: <2-3 example matches>

Be precise. Avoid overly permissive patterns."

output=$(ollama_generate "$MODEL_CHAT" "$(echo "$desc" | truncate_input 4000)" "$system")
if [[ -z "$output" ]]; then
    echo "Failed to generate regex" >&2
    exit 1
fi
echo "$output"
